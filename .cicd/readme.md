# Files
```.
├── .cicd
│   ├── jobs
│   │   ├── build-component.sh
│   │   └── start-build-on-push.sh
│   └── helpers
│       ├── bash_tools.sh
│       ├── compute_version.py
│       ├── docker_build_push.sh
│       ├── package_helm_chart.sh
│       ├── send_slack_message.py
│       └── tag_latest_component_semver.sh
└── .github
    └── workflows
        ├── build-component.yaml
        └── start-build-on-push.yaml
```
Workflows call Jobs
Jobs call Helpers

# Workflow Summary
1.  A user pushes code to a repository.
2.  The "Start-Build-on-Push" GitHub action is triggered.
3.  The action checks out the code and runs the `start-build-on-push.sh` script.
4.  The script creates a new Git tag with the format `component-version/{component_name}/{build_type}/{timestamp}-{username}`.
5.  The "build-component" GitHub action is triggered by the new Git tag.
6.  The action checks out the code and runs the `build-component.sh` script.
7.  The script builds the component and pushes the built artifact (e.g. a Docker image or Helm chart) to a registry.
8.  The script `send_slack_message.py` sends a message to Slack with information about the build, such as the version number of the built artifact and any relevant links or information. This message is sent after the artifact has been built in order to provide an update on the progress of the build process.

start-build-on-push.sh
  |
  v
build-component.sh
  |
  v
compute_version.py
  |
  v
package_helm_chart.sh or docker_build_push.sh
  |
  v
send_slack_message.py
end

# Tagging Strategy
The build process is tag driven. When a new build is started, a new tag is created with the following format:

start-build/(component_name)/(Build_Type)/(Timestamp)-(Username)

`component_name`: The name of the component being built.

`Build_Type`: The type of build being performed. Possible values are: feature, alpha, beta, release, bugfix.

Timestamp: The current timestamp at the time the build is started.

Username: The username of the user who started the build.

For example, if a user named Alice starts a feature build for the xpring-client component at 2022-01-03T12:34:56Z, the resulting tag would be: start-build/xpring-client/feature/2022-01-03T12:34:56Z-Alice


# Building and versioning
Builds are triggered by pushes to branches or tags that match certain patterns. In the `build-component.yaml` file, builds are triggered by pushes to tags that match the pattern `component-version/**`. In the `start-build-on-push.yaml` file, builds are triggered by pushes to any branch. To check the progress of a build, you can use the Github Actions interface on the repository page on the Github website. There, you will be able to see the current status of all builds, as well as the logs for each build.


## Version Numbers
Version numbers are automaticlly generated by the build process.
there are two categories of version numbers that are generated.
[customer-facing]#(customer-facing) and [non-customer-facing]#(non-customer-facing) of the version numbers.

### Build SemVer Elements

| Element | Controlable | Description																								|
------------------------------------------------------------------------------------------------------------------------------------
| "MAJOR" | YES         | "MAJOR" version number retreived from components.yaml file under key `app_name.major_version`				|
| "MINOR" | YES         | "MINOR" version number retreived from components.yaml file under key `app_name.major_version`				|
| "PATCH" | YES         | "PATCH" version number retreived from components.yaml file under key `app_name.major_version`				|
| "JNUM"  | YES         | "JNUM"  Is the Jira card number used in the feature branch and should be of format XXX-#### ex XSRE-123	|
| "BUILD" | No          | "BUILD" version number Generated fby the build pipeline													|

`JNUM` - When you start a build from a feature branch the brach should be prefixed with the Jira card number that is 

### Customer-Facing examples
| Release	| Ex Version # 			| Nomenclature						| Brancher pattern		|
---------------------------------------------------------------------------------------------
| Release	| 1.2.3 				| $MAJOR.$MINOR.$PATCH-$BUILD		| release/**, hotfix/* 	|
| Beta 		| 1.2.3-beta+10 		| $MAJOR.$MINOR.$PATCH-alpha+$BUILD	| beta/* 				|
| Alpha		| 1.2.3-alpha+10 		| $MAJOR.$MINOR.$PATCH-beta+$BUILD	| alpha/* 				|

Each of these are possiable customer facing version numbers

### Not Customer-Facing examples

| Release	| Ex Version # 			| Nomenclature								| Brancher pattern	|
-----------------------------------------------------------------------------------------------------
| main		| 1.2.3-main+10			| $MAJOR.$MINOR.$PATCH-main+$BUILD			| main/* 			|
| feature	| 1.2.3-feature+15 		| $MAJOR.$MINOR.$PATCH-feature$JNUM+$BUILD	| feature/$JNUM-* 	|

### Start-Build Taging format.
Start-build/(component_name)/(Build_Type)/(Timestamp)-(Username)
build types: feature, alpha, beta, release, bugfix

# Script descriptions
## start-build-on-push.sh

This script is used to trigger a build of the component when a new commit is pushed to the repository. It does the following:

-   Set a few environment variables, including the name and version of the component
-   Run `package_helm_chart.sh` to package the Helm chart of the component
-   Run `docker_build_push.sh` to build and push a Docker image of the component to specified registries


## build-component.sh

This script is used to build and package the component. It does the following:

-   Set a few environment variables, including the name and version of the component
-   Run `package_helm_chart.sh` to package the Helm chart of the component
-   Run `docker_build_push.sh` to build and push a Docker image of the component to specified registries


## package_helm_chart.sh

This script is used to package the Helm chart of the component. It does the following:

-   Set a few environment variables, including the name and version of the component and the directory where the Helm chart is located
-   Check if Helm is installed, and install the latest version if it is not
-   Log in to a specified Helm repository
-   Build the dependencies of the Helm chart
-   Package the Helm chart with the specified version
-   Push the packaged Helm chart to the specified Helm repository

## docker_build_push.sh

This script is used to build and push a Docker image of the component to specified registries. It does the following:

-   Set a few environment variables, including the name and version of the component and the directory where the Dockerfile is located
-   Build the Docker image with the specified name and version
-   Tag and push the image to the specified registries


## compute_version.py
This script calculates the version number based on the values of the environment variables `MAJOR_VERSION`, `MINOR_VERSION`, `PATCH_VERSION`, and `STAGE`. It also uses the value of the `JIRA_CARD` environment variable if the `STAGE` is set to feature.

The stage_map dictionary maps the different `STAGE` values to the corresponding version template. The version_template_obj object uses the safe_substitute() method to substitute the values of the environment variables into the version template. Finally, the calculated version number is printed to the console.

Before the version number is calculated, the script checks that all required environment variables are set, and exits with an error message if any are missing. The script also checks that the value of `STAGE` is one of the valid stages listed in the valid_stages set. If the value of `STAGE` is not valid, the script prints an error message and exits.

The script also has a feature to enable simple versions, which means that the version will only consist of the `MAJOR_VERSION` and `MINOR_VERSION` values, without the `PATCH_VERSION` or `STAGE` values. This can be enabled by setting the `ENABLE_SIMPLE_VERSION` environment variable to true.

Here is a summary of the environment variables used by this script:

`MAJOR_VERSION`: The major version number.
`MINOR_VERSION`: The minor version number.
`PATCH_VERSION`: The patch version number.
`STAGE`: The stage of the version. Can be one of feature, beta, alpha, main, release, or simple.
`JIRA_CARD`: The JIRA card number, used only when the STAGE is set to feature.
`ENABLE_SIMPLE_VERSION` (optional): Set to true to enable simple versions.





